name: Deploy DEV

on: 
  push:
    branches: [ dev ]

jobs:
  testing-changes: 
    runs-on: ubuntu-latest
    name: Build/Test
    steps: 
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v3
      with:
        node-version: 14.x

    - name: NPM - Install dependencies
      if: steps.cached-npm-dependencies.outputs.cache-hit != 'true'
      run: 'npm install'
      
    - name: Run Tests
      run: |
        npm run test

  deploy-env:
    name: Deploy Lambda
    runs-on: ubuntu-latest
    needs: testing-changes
    steps: 
    - uses: actions/checkout@v2.0.0
    - uses: actions/setup-node@v3
      with:
        node-version: 14.x

    - name: NPM - Load cache venv
      id: cached-npm-dependencies
      uses: actions/cache@v2
      with:
        path: node_modules
        key: npm-${{ runner.os }}-${{ hashFiles('**/package.json') }}

    - name: NPM - Install dependecies
      if: steps.cached-npm-dependencies.outputs.cache-hit != 'true'
      run: 'npm install'

    - name: Deploy using serverless framework
      run: 'npx sls deploy'
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

